<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ROTA ‚Äî Chedworth Roman Villa</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --blue: #2d4a6b;
    --blue-dark: #1e3349;
    --blue-light: #3a5f8a;
    --red: #7a3f3f;
    --red-dark: #5c2e2e;
    --cream: #f5f0e8;
    --white: #ffffff;
    --gold: #c9a84c;
    --p1-color: #c0392b;
    --p1-light: #e74c3c;
    --p2-color: #f5f0e8;
    --p2-border: #c8bfa8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Crimson Text', serif;
    background: var(--blue-dark);
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    overflow-x: hidden; position: relative;
  }

  .villa-backdrop {
    position: fixed; inset: 0;
    background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Chedworth_Roman_Villa_aerial_view.jpg/1280px-Chedworth_Roman_Villa_aerial_view.jpg');
    background-size: cover; background-position: center top;
    opacity: 0.18; z-index: 0; pointer-events: none;
  }

  .backdrop-overlay {
    position: fixed; inset: 0;
    background: linear-gradient(to bottom, rgba(30,51,73,0.65) 0%, rgba(30,51,73,0.25) 40%, rgba(30,51,73,0.75) 100%);
    z-index: 0; pointer-events: none;
  }

  /* ===================== HOME SCREEN ===================== */
  #homeScreen {
    position: relative; z-index: 10;
    width: 100%; max-width: 460px;
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    padding: 40px 24px 40px;
  }
  #homeScreen.hidden { display: none; }

  .home-hero {
    text-align: center;
    width: 100%;
    margin-bottom: 36px;
    padding-bottom: 24px;
    border-bottom: 1px solid rgba(201,168,76,0.3);
  }

  .home-eyebrow {
    font-family: 'Cinzel', serif;
    font-size: 9px; letter-spacing: 5px;
    color: var(--gold); margin-bottom: 8px;
    text-transform: uppercase;
  }

  .home-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(3.5rem, 16vw, 5.5rem);
    font-weight: 900; color: var(--white);
    letter-spacing: 12px; line-height: 1;
    text-shadow: 0 4px 40px rgba(0,0,0,0.7);
  }

  .home-sub {
    font-family: 'Cinzel', serif;
    font-size: clamp(0.75rem, 3.5vw, 1rem);
    letter-spacing: 2px;
    color: rgba(245,240,232,0.7); margin-top: 10px;
    text-transform: none;
  }

  /* Mode cards */
  .mode-cards {
    width: 100%;
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 14px; margin-bottom: 32px;
  }

  .mode-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 10px;
    padding: 28px 16px 22px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }

  .mode-card::before {
    content: '';
    position: absolute; inset: 0;
    opacity: 0; transition: opacity 0.25s;
    border-radius: 10px;
  }

  .mode-card.two-player::before {
    background: linear-gradient(135deg, rgba(122,63,63,0.5), rgba(192,57,43,0.2));
  }

  .mode-card.vs-ai::before {
    background: linear-gradient(135deg, rgba(45,74,107,0.7), rgba(58,95,138,0.4));
  }

  .mode-card:hover::before, .mode-card:active::before { opacity: 1; }
  .mode-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
  .mode-card:active { transform: translateY(0); }

  .mode-card-icon { font-size: 36px; margin-bottom: 10px; position: relative; }

  .mode-card-title {
    font-family: 'Cinzel', serif;
    font-size: 13px; letter-spacing: 2px;
    color: var(--white); font-weight: 700;
    display: block; margin-bottom: 4px;
    position: relative;
  }

  .mode-card-desc {
    font-family: 'Crimson Text', serif;
    font-size: 13px; color: rgba(255,255,255,0.45);
    font-style: italic; display: block;
    position: relative;
  }

  .mode-card-score {
    margin-top: 12px;
    font-family: 'Cinzel', serif;
    font-size: 11px; letter-spacing: 1px;
    color: var(--gold);
    position: relative;
  }

  /* ===================== NAME SCREEN ===================== */
  #nameScreen {
    position: relative; z-index: 10;
    width: 100%; max-width: 460px;
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    padding: 40px 24px 40px;
  }
  #nameScreen.hidden { display: none; }

  .name-screen-header {
    width: 100%; text-align: center;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(201,168,76,0.3);
  }

  .name-screen-back {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 16px;
  }

  .btn-back-small {
    font-family: 'Cinzel', serif;
    font-size: 9px; letter-spacing: 2px;
    color: rgba(255,255,255,0.4);
    background: none; border: none;
    cursor: pointer; padding: 0;
    transition: color 0.2s;
  }
  .btn-back-small:hover { color: rgba(255,255,255,0.7); }

  .name-screen-mode-icon { font-size: 32px; margin-bottom: 6px; }

  .name-screen-title {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.4rem, 6vw, 2rem);
    font-weight: 700; color: var(--white);
    letter-spacing: 4px;
  }

  .name-screen-sub {
    font-family: 'Crimson Text', serif;
    font-size: 14px; color: rgba(245,240,232,0.45);
    font-style: italic; margin-top: 4px;
  }

  /* Name fields */
  .name-fields { width: 100%; margin-bottom: 28px; }

  .name-field-row {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 12px;
  }

  .name-dot {
    width: 20px; height: 20px; border-radius: 50%; flex-shrink: 0;
  }
  .name-dot.p1 { background: var(--p1-color); border: 2px solid var(--p1-light); }
  .name-dot.p2 { background: var(--p2-color); border: 2px solid var(--p2-border); }

  .name-input {
    flex: 1;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 5px;
    padding: 12px 16px;
    font-family: 'Crimson Text', serif;
    font-size: 17px; color: var(--white);
    outline: none; transition: border-color 0.2s;
  }
  .name-input:focus { border-color: var(--gold); }
  .name-input::placeholder { color: rgba(255,255,255,0.25); font-style: italic; }

  /* Difficulty (AI mode only) */
  .diff-section { width: 100%; margin-bottom: 28px; }

  .diff-label {
    font-family: 'Cinzel', serif;
    font-size: 10px; letter-spacing: 3px;
    color: var(--gold); text-align: center;
    margin-bottom: 10px;
  }

  .diff-cards {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }

  .diff-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 6px; padding: 12px 8px;
    text-align: center; cursor: pointer;
    transition: all 0.2s;
  }

  .diff-card.active {
    background: rgba(122,63,63,0.5);
    border-color: var(--gold);
  }

  .diff-card-title {
    font-family: 'Cinzel', serif;
    font-size: 11px; letter-spacing: 1px;
    color: var(--white); display: block; margin-bottom: 2px;
  }

  .diff-card-desc {
    font-family: 'Crimson Text', serif;
    font-size: 12px; color: rgba(255,255,255,0.4);
    font-style: italic; display: block;
  }

  /* Score tally on name screen */
  .tally-box {
    width: 100%;
    background: rgba(0,0,0,0.25);
    border: 1px solid rgba(201,168,76,0.18);
    border-radius: 6px;
    padding: 14px 20px;
    margin-bottom: 24px;
  }

  .tally-label {
    font-family: 'Cinzel', serif;
    font-size: 9px; letter-spacing: 3px;
    color: rgba(201,168,76,0.6); text-align: center;
    margin-bottom: 10px;
  }

  .tally-row {
    display: flex; justify-content: space-around; align-items: center;
  }

  .tally-item { text-align: center; }

  .tally-num {
    font-family: 'Cinzel', serif;
    font-size: 2rem; font-weight: 900;
    color: var(--gold); line-height: 1;
  }

  .tally-name {
    font-family: 'Crimson Text', serif;
    font-size: 12px; color: rgba(255,255,255,0.5);
    font-style: italic; margin-top: 2px;
  }

  .tally-vs {
    font-family: 'Cinzel', serif;
    font-size: 11px; color: rgba(201,168,76,0.3);
    letter-spacing: 2px;
  }

  .btn-reset-tally {
    background: none; border: none;
    font-family: 'Crimson Text', serif;
    font-size: 11px; color: rgba(255,255,255,0.25);
    cursor: pointer; text-decoration: underline;
    display: block; margin: 8px auto 0;
    font-style: italic;
  }
  .btn-reset-tally:hover { color: rgba(255,255,255,0.45); }

  /* Begin button */
  .btn-begin {
    font-family: 'Cinzel', serif;
    font-size: 13px; letter-spacing: 4px;
    color: var(--blue-dark); background: var(--gold);
    border: none; padding: 16px 0; border-radius: 4px;
    cursor: pointer; font-weight: 700; width: 100%;
    box-shadow: 0 4px 20px rgba(201,168,76,0.25);
    transition: all 0.2s; margin-bottom: 20px;
  }
  .btn-begin:hover { background: #e0bc5a; transform: translateY(-1px); }
  .btn-begin:active { transform: translateY(0); }

  .chedworth-link {
    font-family: 'Crimson Text', serif;
    font-size: 16px; color: rgba(245,240,232,0.5);
    font-style: italic; text-align: center;
  }
  .chedworth-link a {
    color: var(--gold); text-decoration: none;
    border-bottom: 1px solid rgba(201,168,76,0.4);
    font-size: 17px;
    transition: color 0.2s;
  }
  .chedworth-link a:hover { color: #e0bc5a; }

  /* ===================== GAME SCREEN ===================== */
  #gameScreen {
    position: relative; z-index: 1;
    width: 100%; max-width: 520px;
    min-height: 100vh;
    display: flex; flex-direction: column; align-items: center;
    padding: 0 16px 32px;
  }
  #gameScreen.hidden { display: none; }

  .header {
    width: 100%; text-align: center;
    padding: 14px 0 10px;
    border-bottom: 1px solid rgba(201,168,76,0.3);
    margin-bottom: 12px;
  }

  .header-eyebrow {
    font-family: 'Cinzel', serif;
    font-size: 8px; letter-spacing: 4px; color: var(--gold); margin-bottom: 2px;
  }

  .header h1 {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.8rem, 7vw, 2.5rem);
    font-weight: 900; color: var(--white); letter-spacing: 8px;
    text-shadow: 0 2px 20px rgba(0,0,0,0.5);
  }

  .header-sub {
    font-family: 'Cinzel', serif;
    font-size: 8px; letter-spacing: 3px;
    color: rgba(245,240,232,0.4); margin-top: 3px;
  }

  .header-controls {
    display: flex; justify-content: space-between; align-items: center;
    margin-top: 8px;
  }

  .btn-menu-small {
    font-family: 'Cinzel', serif;
    font-size: 9px; letter-spacing: 2px;
    color: rgba(255,255,255,0.45);
    background: none; border: 1px solid rgba(255,255,255,0.15);
    border-radius: 3px; padding: 5px 10px;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-menu-small:hover { color: var(--white); border-color: rgba(255,255,255,0.4); }

  .diff-toggle {
    display: flex;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 4px; overflow: hidden;
  }

  .diff-toggle-btn {
    font-family: 'Cinzel', serif;
    font-size: 8px; letter-spacing: 1px;
    padding: 5px 9px;
    background: none; border: none;
    color: rgba(255,255,255,0.35);
    cursor: pointer; transition: all 0.2s;
  }
  .diff-toggle-btn.active { background: var(--red-dark); color: var(--white); }

  /* Score bar */
  .score-bar {
    width: 100%;
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(0,0,0,0.28);
    border: 1px solid rgba(201,168,76,0.18);
    border-radius: 4px;
    padding: 8px 16px; margin-bottom: 10px;
  }

  .score-bar-item { text-align: center; flex: 1; }

  .score-bar-num {
    font-family: 'Cinzel', serif;
    font-size: 1.5rem; font-weight: 900; color: var(--gold); line-height: 1;
  }

  .score-bar-name {
    font-family: 'Crimson Text', serif;
    font-size: 12px; color: rgba(255,255,255,0.5); font-style: italic;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;
  }

  .score-bar-vs {
    font-family: 'Cinzel', serif;
    font-size: 10px; color: rgba(201,168,76,0.35);
    letter-spacing: 2px; padding: 0 8px;
  }

  /* Phase banner */
  .phase-banner {
    width: 100%; padding: 10px 20px;
    border-radius: 4px; text-align: center;
    margin-bottom: 10px;
    transition: background 0.35s ease;
    border: 1px solid rgba(255,255,255,0.08);
  }

  .phase-banner.player1-turn { background: linear-gradient(135deg, var(--red-dark), var(--red)); }
  .phase-banner.player2-turn { background: linear-gradient(135deg, var(--blue), #3a5f8a); }
  .phase-banner.ai-thinking-bg { background: linear-gradient(135deg, #243824, #3a5a3a); }
  .phase-banner.game-over-banner { background: linear-gradient(135deg, #2a5a2a, #3d8b3d); }

  .turn-label {
    font-family: 'Cinzel', serif;
    font-size: 10px; letter-spacing: 3px;
    color: rgba(255,255,255,0.65); margin-bottom: 2px;
  }

  .turn-name {
    font-family: 'Cinzel', serif;
    font-size: clamp(1rem, 4vw, 1.3rem);
    font-weight: 700; color: var(--white); letter-spacing: 2px;
  }

  .phase-label {
    font-family: 'Crimson Text', serif;
    font-size: 13px; color: rgba(255,255,255,0.6);
    font-style: italic; margin-top: 2px;
  }

  /* Counters row */
  .counters-row {
    display: flex; justify-content: space-between; align-items: center;
    width: 100%; margin-bottom: 8px; padding: 0 4px;
  }

  .player-info { display: flex; align-items: center; gap: 8px; flex: 1; }
  .player-info.p2 { flex-direction: row-reverse; }

  .counter-dots { display: flex; gap: 5px; }

  .counter-dot {
    width: 20px; height: 20px; border-radius: 50%; transition: all 0.3s;
  }
  .counter-dot.p1 { background: var(--p1-color); border: 2px solid var(--p1-light); box-shadow: 0 0 5px rgba(192,57,43,0.35); }
  .counter-dot.p2 { background: var(--p2-color); border: 2px solid var(--p2-border); box-shadow: 0 0 5px rgba(245,240,232,0.2); }

  .player-label {
    font-family: 'Cinzel', serif;
    font-size: 11px; letter-spacing: 1px;
    color: rgba(255,255,255,0.6);
    max-width: 90px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  .vs-label {
    font-family: 'Cinzel', serif;
    font-size: 10px; color: rgba(201,168,76,0.5);
    letter-spacing: 2px; padding: 0 6px;
  }

  /* Board */
  .board-wrapper {
    width: 100%; max-width: 370px;
    margin: 4px 0;
  }

  .board-wrapper svg {
    width: 100%; height: auto;
    filter: drop-shadow(0 8px 32px rgba(0,0,0,0.6));
    border-radius: 8px;
  }

  .node-hitarea { cursor: pointer; }
  .node-hitarea:active { opacity: 0.7; }

  .instruction-text {
    font-family: 'Crimson Text', serif;
    font-size: 15px; color: rgba(245,240,232,0.7);
    text-align: center; font-style: italic;
    margin: 7px 0; min-height: 22px;
  }

  /* AI thinking */
  .ai-thinking-row {
    height: 20px; display: flex; align-items: center; justify-content: center;
    margin-bottom: 2px;
  }

  .ai-thinking-text {
    font-family: 'Crimson Text', serif;
    font-size: 13px; color: rgba(255,255,255,0.5);
    font-style: italic; display: none;
  }

  .ai-thinking-text.visible { display: block; }

  .thinking-dots::after {
    content: '';
    animation: dots 1.4s steps(4, end) infinite;
  }

  @keyframes dots {
    0%,20%{content:''} 40%{content:'.'} 60%{content:'..'} 80%,100%{content:'...'}
  }

  /* How to play */
  .how-to-play {
    width: 100%; margin-top: 14px;
    border: 1px solid rgba(201,168,76,0.18); border-radius: 4px; overflow: hidden;
  }

  .htp-header {
    background: rgba(45,74,107,0.55);
    padding: 10px 16px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; border: none; width: 100%;
  }

  .htp-header span { font-family: 'Cinzel', serif; font-size: 10px; letter-spacing: 3px; color: var(--gold); }
  .htp-arrow { color: var(--gold); font-size: 11px; transition: transform 0.3s; }
  .htp-arrow.open { transform: rotate(180deg); }

  .htp-body {
    background: rgba(20,35,55,0.55);
    max-height: 0; overflow: hidden;
    transition: max-height 0.35s ease, padding 0.35s ease;
    padding: 0 16px;
  }

  .htp-body.open { max-height: 400px; padding: 14px 16px; }

  .htp-body p {
    font-family: 'Crimson Text', serif;
    font-size: 15px; color: rgba(245,240,232,0.8);
    line-height: 1.6; margin-bottom: 8px;
  }
  .htp-body p:last-child { margin-bottom: 0; }
  .htp-body strong { color: var(--gold); }

  /* Footer */
  .footer { margin-top: 18px; text-align: center; opacity: 0.35; }
  .footer p { font-family: 'Cinzel', serif; font-size: 8px; letter-spacing: 3px; color: var(--cream); }
  .footer a { color: var(--gold); text-decoration: none; }

  /* Win overlay */
  .win-overlay {
    position: fixed; inset: 0; z-index: 100;
    display: flex; align-items: center; justify-content: center;
    background: rgba(10,20,35,0.93); backdrop-filter: blur(4px);
    animation: fadeIn 0.4s ease;
  }
  .win-overlay.hidden { display: none; }

  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  .win-card {
    background: linear-gradient(145deg, var(--blue-dark), var(--blue));
    border: 1px solid var(--gold); border-radius: 8px;
    padding: 36px 28px; text-align: center;
    max-width: 320px; width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: slideUp 0.4s ease;
  }

  @keyframes slideUp { from{transform:translateY(30px);opacity:0} to{transform:translateY(0);opacity:1} }

  .win-laurel { font-size: 28px; margin-bottom: 6px; letter-spacing: 8px; }
  .win-title { font-family:'Cinzel',serif; font-size:10px; letter-spacing:4px; color:var(--gold); margin-bottom:5px; }

  .win-player {
    font-family: 'Cinzel', serif;
    font-size: clamp(1.4rem, 5vw, 1.9rem);
    font-weight: 900; color: var(--white); letter-spacing: 2px; margin-bottom: 3px;
  }

  .win-subtitle {
    font-family: 'Crimson Text', serif;
    font-size: 16px; color: rgba(245,240,232,0.55);
    font-style: italic; margin-bottom: 16px;
  }

  .win-score-box {
    font-family: 'Cinzel', serif;
    font-size: 11px; letter-spacing: 2px; color: var(--gold);
    background: rgba(201,168,76,0.08);
    border: 1px solid rgba(201,168,76,0.2);
    border-radius: 4px; padding: 10px 16px; margin-bottom: 20px;
  }

  .win-buttons { display: flex; flex-direction: column; gap: 8px; }

  .btn-play-again {
    font-family: 'Cinzel', serif; font-size: 12px; letter-spacing: 3px;
    color: var(--blue-dark); background: var(--gold);
    border: none; padding: 13px; border-radius: 3px;
    cursor: pointer; font-weight: 700; transition: all 0.2s;
  }
  .btn-play-again:hover { background: #e0bc5a; transform: translateY(-1px); }

  .btn-go-home {
    font-family: 'Cinzel', serif; font-size: 11px; letter-spacing: 2px;
    color: rgba(255,255,255,0.55);
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.18);
    padding: 10px; border-radius: 3px;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-go-home:hover { color: var(--white); }
</style>
</head>
<body>

<div class="villa-backdrop"></div>
<div class="backdrop-overlay"></div>

<!-- ===================== HOME SCREEN ===================== -->
<div id="homeScreen">
  <div class="home-hero">
    <div class="home-eyebrow">Ancient Roman Game</div>
    <div class="home-title">ROTA</div>
    <div class="home-sub">Chedworth Roman Villa</div>
  </div>

  <div class="mode-cards">
    <div class="mode-card two-player" onclick="showNameScreen('2p')">
      <div class="mode-card-icon">üë•</div>
      <span class="mode-card-title">Two Players</span>
      <span class="mode-card-desc">Pass & play</span>
      <div class="mode-card-score" id="homeScore2P">‚Äî</div>
    </div>
    <div class="mode-card vs-ai" onclick="showNameScreen('ai')">
      <div class="mode-card-icon">üèõÔ∏è</div>
      <span class="mode-card-title">Play the AI</span>
      <span class="mode-card-desc">Solo challenge</span>
      <div class="mode-card-score" id="homeScoreAI">‚Äî</div>
    </div>
  </div>

  <div class="chedworth-link">
    <a href="https://www.nationaltrust.org.uk/visit/gloucestershire-cotswolds/chedworth-roman-villa/events" target="_blank">Visit Chedworth Roman Villa</a>
  </div>
</div>

<!-- ===================== NAME SCREEN ===================== -->
<div id="nameScreen" class="hidden">
  <div class="name-screen-header">
    <div class="name-screen-back">
      <button class="btn-back-small" onclick="showHome()">‚óÄ Back</button>
    </div>
    <div class="name-screen-mode-icon" id="nameScreenIcon">üë•</div>
    <div class="name-screen-title" id="nameScreenTitle">Two Players</div>
    <div class="name-screen-sub" id="nameScreenSub">Enter your names to begin</div>
  </div>

  <div class="name-fields">
    <div class="name-field-row">
      <div class="name-dot p1"></div>
      <input class="name-input" id="nameInput1" type="text" maxlength="16" placeholder="Player I name‚Ä¶" />
    </div>
    <div class="name-field-row" id="nameField2Row">
      <div class="name-dot p2"></div>
      <input class="name-input" id="nameInput2" type="text" maxlength="16" placeholder="Player II name‚Ä¶" />
    </div>
  </div>

  <!-- Difficulty (AI only) -->
  <div class="diff-section" id="diffSection" style="display:none;">
    <div class="diff-label">Difficulty</div>
    <div class="diff-cards">
      <div class="diff-card" id="dcEasy" onclick="selectDiff('easy')">
        <span class="diff-card-title">Easy</span>
        <span class="diff-card-desc">Beginner</span>
      </div>
      <div class="diff-card active" id="dcMedium" onclick="selectDiff('medium')">
        <span class="diff-card-title">Medium</span>
        <span class="diff-card-desc">Challenge</span>
      </div>
      <div class="diff-card" id="dcHard" onclick="selectDiff('hard')">
        <span class="diff-card-title">Hard</span>
        <span class="diff-card-desc">Unbeatable</span>
      </div>
    </div>
  </div>

  <!-- Score tally -->
  <div class="tally-box">
    <div class="tally-label">Score Tally</div>
    <div class="tally-row">
      <div class="tally-item">
        <div class="tally-num" id="tallyNum1">0</div>
        <div class="tally-name" id="tallyName1">Player I</div>
      </div>
      <div class="tally-vs">VS</div>
      <div class="tally-item">
        <div class="tally-num" id="tallyNum2">0</div>
        <div class="tally-name" id="tallyName2">Player II</div>
      </div>
    </div>
    <button class="btn-reset-tally" onclick="resetCurrentTally()">Reset scores</button>
  </div>

  <button class="btn-begin" onclick="startGame()">Begin</button>

  <div class="chedworth-link">
    <a href="https://www.nationaltrust.org.uk/visit/gloucestershire-cotswolds/chedworth-roman-villa/events" target="_blank">Visit Chedworth Roman Villa</a>
  </div>
</div>

<!-- ===================== GAME SCREEN ===================== -->
<div id="gameScreen" class="hidden">

  <header class="header">
    <div class="header-eyebrow">Ancient Roman Game</div>
    <h1>ROTA</h1>
    <div class="header-sub">Chedworth Roman Villa</div>
    <div class="header-controls">
      <button class="btn-menu-small" onclick="goHome()">‚óÄ Menu</button>
      <div class="diff-toggle" id="diffToggleGame" style="display:none;">
        <button class="diff-toggle-btn" id="dtEasy" onclick="changeDiff('easy')">Easy</button>
        <button class="diff-toggle-btn active" id="dtMedium" onclick="changeDiff('medium')">Medium</button>
        <button class="diff-toggle-btn" id="dtHard" onclick="changeDiff('hard')">Hard</button>
      </div>
    </div>
  </header>

  <!-- Score bar -->
  <div class="score-bar">
    <div class="score-bar-item">
      <div class="score-bar-num" id="gameScore1">0</div>
      <div class="score-bar-name" id="gameScoreName1">Player I</div>
    </div>
    <div class="score-bar-vs">VS</div>
    <div class="score-bar-item">
      <div class="score-bar-num" id="gameScore2">0</div>
      <div class="score-bar-name" id="gameScoreName2">Player II</div>
    </div>
  </div>

  <!-- Phase banner -->
  <div class="phase-banner player1-turn" id="phaseBanner">
    <div class="turn-label">Current Turn</div>
    <div class="turn-name" id="turnName">Player I</div>
    <div class="phase-label" id="phaseLabel">Place your counter</div>
  </div>

  <!-- AI thinking -->
  <div class="ai-thinking-row">
    <span class="ai-thinking-text" id="aiThinkingText">Thinking<span class="thinking-dots"></span></span>
  </div>

  <!-- Counters -->
  <div class="counters-row">
    <div class="player-info p1">
      <div class="counter-dots" id="p1Dots"></div>
      <div class="player-label" id="labelP1">Player I</div>
    </div>
    <div class="vs-label">VS</div>
    <div class="player-info p2">
      <div class="player-label" id="labelP2">Player II</div>
      <div class="counter-dots" id="p2Dots"></div>
    </div>
  </div>

  <!-- Board -->
  <div class="board-wrapper">
    <svg id="rotaBoard" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
      <rect width="400" height="400" fill="#111111" rx="8"/>
      <rect x="8" y="8" width="384" height="384" fill="none" stroke="#2a2a2a" stroke-width="1" rx="6"/>
      <circle cx="200" cy="200" r="155" fill="none" stroke="#e8e0cc" stroke-width="2.5"/>
      <line x1="200" y1="45" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="310" y1="90" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="355" y1="200" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="310" y1="310" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="200" y1="355" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="90" y1="310" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="45" y1="200" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="90" y1="90" x2="200" y2="200" stroke="#e8e0cc" stroke-width="2.5" stroke-linecap="round"/>
      <!-- Nodes -->
      <circle id="node0" cx="200" cy="45" r="22"/>
      <circle id="node1" cx="310" cy="90" r="22"/>
      <circle id="node2" cx="355" cy="200" r="22"/>
      <circle id="node3" cx="310" cy="310" r="22"/>
      <circle id="node4" cx="200" cy="355" r="22"/>
      <circle id="node5" cx="90" cy="310" r="22"/>
      <circle id="node6" cx="45" cy="200" r="22"/>
      <circle id="node7" cx="90" cy="90" r="22"/>
      <circle id="node8" cx="200" cy="200" r="22"/>
      <!-- Hit areas -->
      <circle class="node-hitarea" cx="200" cy="45" r="36" fill="transparent" onclick="handleNodeClick(0)"/>
      <circle class="node-hitarea" cx="310" cy="90" r="36" fill="transparent" onclick="handleNodeClick(1)"/>
      <circle class="node-hitarea" cx="355" cy="200" r="36" fill="transparent" onclick="handleNodeClick(2)"/>
      <circle class="node-hitarea" cx="310" cy="310" r="36" fill="transparent" onclick="handleNodeClick(3)"/>
      <circle class="node-hitarea" cx="200" cy="355" r="36" fill="transparent" onclick="handleNodeClick(4)"/>
      <circle class="node-hitarea" cx="90" cy="310" r="36" fill="transparent" onclick="handleNodeClick(5)"/>
      <circle class="node-hitarea" cx="45" cy="200" r="36" fill="transparent" onclick="handleNodeClick(6)"/>
      <circle class="node-hitarea" cx="90" cy="90" r="36" fill="transparent" onclick="handleNodeClick(7)"/>
      <circle class="node-hitarea" cx="200" cy="200" r="36" fill="transparent" onclick="handleNodeClick(8)"/>
    </svg>
  </div>

  <div class="instruction-text" id="instructionText">Place your counter on any empty spot</div>

  <div class="how-to-play">
    <button class="htp-header" onclick="toggleHTP()">
      <span>How to Play</span>
      <span class="htp-arrow" id="htpArrow">‚ñº</span>
    </button>
    <div class="htp-body" id="htpBody">
      <p><strong>Aim:</strong> Be the first to get 3 of your counters in a row.</p>
      <p><strong>Phase 1 ‚Äî Placing:</strong> Take turns placing one counter on any empty spot. Each player has 3 counters.</p>
      <p><strong>Phase 2 ‚Äî Moving:</strong> Once all counters are placed, slide one counter per turn along a line to an adjacent empty spot. No jumping.</p>
      <p><strong>Winning:</strong> Three consecutive spots around the outer ring, or 3 in a straight line through the centre. A spread-out triangle does <em>not</em> count.</p>
    </div>
  </div>

  <footer class="footer">
    <p><a href="https://www.nationaltrust.org.uk/visit/gloucestershire-cotswolds/chedworth-roman-villa/events" target="_blank">Chedworth Roman Villa</a></p>
  </footer>
</div>

<!-- Win Overlay -->
<div class="win-overlay hidden" id="winOverlay">
  <div class="win-card">
    <div class="win-laurel">üèõÔ∏è</div>
    <div class="win-title">Victoria!</div>
    <div class="win-player" id="winPlayerName">Player I</div>
    <div class="win-subtitle">wins the game of Rota</div>
    <div class="win-score-box" id="winScoreBox">0 ‚Äî 0</div>
    <div class="win-buttons">
      <button class="btn-play-again" onclick="resetGame()">Play Again</button>
      <button class="btn-go-home" onclick="goHome()">Back to Menu</button>
    </div>
  </div>
</div>

<script>
// =============================================
// CONSTANTS
// =============================================

const ADJACENCY = {
  0:[1,7,8], 1:[0,2,8], 2:[1,3,8], 3:[2,4,8],
  4:[3,5,8], 5:[4,6,8], 6:[5,7,8], 7:[6,0,8],
  8:[0,1,2,3,4,5,6,7]
};

const WIN_LINES = [
  [0,1,2],[1,2,3],[2,3,4],[3,4,5],
  [4,5,6],[5,6,7],[6,7,0],[7,0,1],
  [0,8,4],[1,8,5],[2,8,6],[3,8,7]
];

// =============================================
// STATE
// =============================================

let board, currentPlayer, phase, placedCount, selectedNode, gameOver;
let aiEnabled = false;
let aiDifficulty = 'medium';
let playerNames = ['Player I', 'Player II'];
let currentMode = '2p'; // '2p' or 'ai'
let aiTimer = null;

// Siloed scores
let scores = { '2p': {p1:0, p2:0}, 'ai': {p1:0, p2:0} };

// =============================================
// PERSISTENCE
// =============================================

function saveScores() {
  try { localStorage.setItem('rotaScoresV3', JSON.stringify(scores)); } catch(e) {}
}

function loadScores() {
  try {
    const s = localStorage.getItem('rotaScoresV3');
    if (s) scores = JSON.parse(s);
  } catch(e) {}
}

// =============================================
// HOME SCREEN
// =============================================

function showHome() {
  document.getElementById('homeScreen').classList.remove('hidden');
  document.getElementById('nameScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.add('hidden');
  document.getElementById('winOverlay').classList.add('hidden');

  // If name inputs are blank it's a fresh session ‚Äî clear displayed scores
  const n1 = document.getElementById('nameInput1').value.trim();
  const n2 = document.getElementById('nameInput2').value.trim();
  if (!n1 && !n2) {
    scores['2p'] = {p1: 0, p2: 0};
    scores['ai'] = {p1: 0, p2: 0};
    saveScores();
  }

  updateHomeScores();
}

function updateHomeScores() {
  const s2p = scores['2p'];
  const sai = scores['ai'];

  // Show running totals on mode cards
  const has2p = s2p.p1 + s2p.p2 > 0;
  const hasAI = sai.p1 + sai.p2 > 0;

  document.getElementById('homeScore2P').textContent = has2p ? `${s2p.p1} ‚Äî ${s2p.p2}` : '‚Äî';
  document.getElementById('homeScoreAI').textContent = hasAI ? `${sai.p1} ‚Äî ${sai.p2}` : '‚Äî';
}

// =============================================
// NAME SCREEN
// =============================================

let pendingMode = '2p';
let pendingDiff = 'medium';

function showNameScreen(mode) {
  pendingMode = mode;
  document.getElementById('homeScreen').classList.add('hidden');
  document.getElementById('nameScreen').classList.remove('hidden');

  if (mode === '2p') {
    document.getElementById('nameScreenIcon').textContent = 'üë•';
    document.getElementById('nameScreenTitle').textContent = 'Two Players';
    document.getElementById('nameScreenSub').textContent = 'Enter your names to begin';
    document.getElementById('nameField2Row').style.display = 'flex';
    document.getElementById('nameInput2').disabled = false;
    document.getElementById('nameInput2').placeholder = 'Player II name‚Ä¶';
    document.getElementById('diffSection').style.display = 'none';
  } else {
    document.getElementById('nameScreenIcon').textContent = 'üèõÔ∏è';
    document.getElementById('nameScreenTitle').textContent = 'Play the AI';
    document.getElementById('nameScreenSub').textContent = 'Enter your name to begin';
    document.getElementById('nameField2Row').style.display = 'none';
    document.getElementById('diffSection').style.display = 'block';
  }

  updateTallyDisplay();
  selectDiff(pendingDiff);
}

function selectDiff(diff) {
  pendingDiff = diff;
  ['easy','medium','hard'].forEach(d => {
    document.getElementById('dc' + cap(d)).classList.toggle('active', d === diff);
  });
}

function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

function updateTallyDisplay() {
  const s = scores[pendingMode];
  const n1 = document.getElementById('nameInput1').value.trim() || 'Player I';
  const n2 = pendingMode === 'ai' ? 'The AI' : (document.getElementById('nameInput2').value.trim() || 'Player II');

  document.getElementById('tallyNum1').textContent = s.p1;
  document.getElementById('tallyNum2').textContent = s.p2;
  document.getElementById('tallyName1').textContent = n1;
  document.getElementById('tallyName2').textContent = n2;
}

function resetCurrentTally() {
  scores[pendingMode] = {p1:0, p2:0};
  saveScores();
  updateTallyDisplay();
  updateHomeScores();
}

// =============================================
// START GAME
// =============================================

function startGame() {
  const n1 = document.getElementById('nameInput1').value.trim() || 'Player I';
  const n2 = pendingMode === 'ai' ? 'The AI' : (document.getElementById('nameInput2').value.trim() || 'Player II');

  // If names have changed, reset scores for this mode
  const prev = loadSessionNames(pendingMode);
  if (prev.n1 !== n1 || prev.n2 !== n2) {
    scores[pendingMode] = {p1: 0, p2: 0};
    saveScores();
  }
  saveSessionNames(pendingMode, n1, n2);

  playerNames = [n1, n2];
  currentMode = pendingMode;
  aiEnabled = (currentMode === 'ai');
  aiDifficulty = pendingDiff;

  document.getElementById('nameScreen').classList.add('hidden');
  document.getElementById('gameScreen').classList.remove('hidden');

  trackGameStart(currentMode);
  syncDiffToggleGame();
  updateScoreBar();
  resetGame();
}

function saveSessionNames(mode, n1, n2) {
  try { localStorage.setItem('rotaNames_' + mode, JSON.stringify({n1, n2})); } catch(e) {}
}

function loadSessionNames(mode) {
  try {
    const s = localStorage.getItem('rotaNames_' + mode);
    return s ? JSON.parse(s) : {n1: '', n2: ''};
  } catch(e) { return {n1: '', n2: ''}; }
}

function goHome() {
  if (aiTimer) clearTimeout(aiTimer);
  document.getElementById('winOverlay').classList.add('hidden');
  showHome();
}

// =============================================
// DIFFICULTY TOGGLE (in-game)
// =============================================

function changeDiff(diff) {
  aiDifficulty = diff;
  syncDiffToggleGame();
  resetGame();
}

function syncDiffToggleGame() {
  ['easy','medium','hard'].forEach(d => {
    const btn = document.getElementById('dt' + cap(d));
    if (btn) btn.classList.toggle('active', d === aiDifficulty);
  });
}

// =============================================
// GAME LOGIC
// =============================================

function resetGame() {
  if (aiTimer) clearTimeout(aiTimer);
  board = new Array(9).fill(null);
  currentPlayer = 1;
  phase = 'placing';
  placedCount = [0,0];
  selectedNode = null;
  gameOver = false;
  document.getElementById('winOverlay').classList.add('hidden');
  document.getElementById('aiThinkingText').classList.remove('visible');
  // Reset winning line animation
  for (let i = 0; i < 9; i++) {
    const el = document.getElementById('node' + i);
    if (el) { el.style.opacity = '1'; el.setAttribute('r', '22'); }
  }
  renderBoard();
  updateUI();
}

function handleNodeClick(index) {
  if (gameOver) return;
  if (aiEnabled && currentPlayer === 2) return;
  if (phase === 'placing') handlePlacing(index);
  else handleMoving(index);
}

function handlePlacing(index) {
  if (board[index] !== null) { setInstruction('That spot is taken ‚Äî choose an empty one'); return; }
  board[index] = currentPlayer;
  placedCount[currentPlayer - 1]++;
  if (checkWin(currentPlayer)) { renderBoard(); endGame(currentPlayer); return; }
  if (placedCount[0] === 3 && placedCount[1] === 3) phase = 'moving';
  switchPlayer(); renderBoard(); updateUI(); maybeAI();
}

function handleMoving(index) {
  if (selectedNode === null) {
    if (board[index] !== currentPlayer) {
      setInstruction(board[index] !== null ? "That's your opponent's counter" : 'Select one of your counters first');
      return;
    }
    selectedNode = index; renderBoard();
    setInstruction('Tap an adjacent empty spot to move there');
  } else {
    if (index === selectedNode) {
      selectedNode = null; renderBoard();
      setInstruction('Select one of your counters to move'); return;
    }
    if (board[index] !== null) {
      if (board[index] === currentPlayer) {
        selectedNode = index; renderBoard();
        setInstruction('Tap an adjacent empty spot to move there');
      } else setInstruction("You can't move onto your opponent's counter");
      return;
    }
    if (!ADJACENCY[selectedNode].includes(index)) {
      setInstruction('You can only move to an adjacent spot along a line'); return;
    }
    board[index] = currentPlayer; board[selectedNode] = null; selectedNode = null;
    if (checkWin(currentPlayer)) { renderBoard(); endGame(currentPlayer); return; }
    switchPlayer(); renderBoard(); updateUI(); maybeAI();
  }
}

function switchPlayer() { currentPlayer = currentPlayer === 1 ? 2 : 1; }

function checkWin(player) {
  return WIN_LINES.some(line => line.every(i => board[i] === player));
}

function getWinLine(player) {
  return WIN_LINES.find(line => line.every(i => board[i] === player));
}

function endGame(winner) {
  gameOver = true;
  if (winner === 1) scores[currentMode].p1++;
  else scores[currentMode].p2++;
  saveScores();
  updateHomeScores();

  const winLine = getWinLine(winner);
  if (winLine) showWinningLine(winLine, winner);

  const s = scores[currentMode];
  document.getElementById('winPlayerName').textContent = playerNames[winner - 1];
  document.getElementById('winScoreBox').textContent = `${playerNames[0]}: ${s.p1}  ‚Äî  ${playerNames[1]}: ${s.p2}`;
  document.getElementById('aiThinkingText').classList.remove('visible');

  const banner = document.getElementById('phaseBanner');
  banner.className = 'phase-banner game-over-banner';
  document.getElementById('turnName').textContent = playerNames[winner - 1] + ' wins!';
  document.getElementById('phaseLabel').textContent = 'Victoria!';
  updateScoreBar();

  document.getElementById('rotaBoard').style.cursor = '';
  // Win overlay appears automatically after winning line animation completes
  // 3 nodes √ó 500ms apart + 600ms buffer = 2100ms total
  setTimeout(() => {
    document.getElementById('winOverlay').classList.remove('hidden');
  }, 2100);
}

function showWinningLine(line, winner) {
  // Dim all non-winning nodes
  for (let i = 0; i < 9; i++) {
    const el = document.getElementById('node' + i);
    if (!el) continue;
    if (!line.includes(i)) {
      el.style.opacity = '0.2';
    }
  }

  // Light up each winning node gold, one by one, slowly
  line.forEach((idx, step) => {
    const el = document.getElementById('node' + idx);
    if (!el) return;
    setTimeout(() => {
      el.style.fill = '#c9a84c';
      el.style.stroke = '#fff5cc';
      el.style.strokeWidth = '4';
      el.style.strokeDasharray = '';
      el.style.opacity = '1';
      // Pulse size
      el.setAttribute('r', '28');
      setTimeout(() => {
        el.setAttribute('r', '24');
        setTimeout(() => el.setAttribute('r', '22'), 200);
      }, 200);
    }, step * 500); // 500ms between each node ‚Äî nice and slow
  });
}

// =============================================
// AI
// =============================================

function maybeAI() {
  if (!aiEnabled || currentPlayer !== 2 || gameOver) return;
  document.getElementById('aiThinkingText').classList.add('visible');
  document.getElementById('phaseBanner').className = 'phase-banner ai-thinking-bg';
  document.getElementById('turnName').textContent = 'The AI';
  document.getElementById('phaseLabel').textContent = 'Thinking‚Ä¶';

  const delay = {easy: 700, medium: 950, hard: 1200}[aiDifficulty];
  aiTimer = setTimeout(() => {
    document.getElementById('aiThinkingText').classList.remove('visible');
    doAI();
  }, delay);
}

function doAI() {
  if (gameOver) return;
  if (phase === 'placing') {
    const move = aiPickPlace();
    board[move] = 2; placedCount[1]++;
    renderBoard();
    if (checkWin(2)) { endGame(2); return; }
    if (placedCount[0] === 3 && placedCount[1] === 3) phase = 'moving';
    switchPlayer(); updateUI();
  } else {
    const mv = aiPickMove();
    if (mv) { board[mv.to] = 2; board[mv.from] = null; }
    renderBoard();
    if (checkWin(2)) { endGame(2); return; }
    switchPlayer(); updateUI();
  }
}

function empties() { return board.map((v,i)=>v===null?i:-1).filter(i=>i!==-1); }
function rand(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function aiPickPlace() {
  // Win immediately
  const win = findWinMove(2);
  if (win !== -1) return win;

  // Block immediate win
  const block = findWinMove(1);
  if (block !== -1) return block;

  if (aiDifficulty === 'easy') {
    if (Math.random() < 0.3) {
      if (board[8] === null) return 8;
      const good = empties().filter(n => WIN_LINES.some(l => l.includes(n) && l.filter(i=>board[i]===2).length===1));
      if (good.length) return rand(good);
    }
    return rand(empties());
  }

  if (aiDifficulty === 'medium') {
    if (board[8] === null) return 8;
    const good = empties().filter(n => WIN_LINES.some(l => l.includes(n) && l.filter(i=>board[i]===2).length===1));
    if (good.length) return rand(good);
    return rand(empties());
  }

  // Hard: fork-aware scored placement
  if (board[8] === null) return 8;

  // Block opponent fork (two winning threats at once)
  const oppFork = findForkMove(1);
  if (oppFork !== -1) return oppFork;

  // Create our own fork
  const myFork = findForkMove(2);
  if (myFork !== -1) return myFork;

  const opts = empties().map(n => ({n, s: scorePlace(n, 2) - scorePlace(n, 1)*0.7}));
  opts.sort((a,b)=>b.s-a.s);
  return opts[0].n;
}

// Count how many winning threats a player would have after placing at a node
function countThreats(player, node) {
  board[node] = player;
  let threats = 0;
  for (const line of WIN_LINES) {
    const mine = line.filter(i => board[i] === player).length;
    const free = line.filter(i => board[i] === null).length;
    if (mine === 2 && free === 1) threats++;
  }
  board[node] = null;
  return threats;
}

// Find a move that creates 2+ threats (a fork) for the given player
function findForkMove(player) {
  for (const node of empties()) {
    if (countThreats(player, node) >= 2) return node;
  }
  return -1;
}

function findWinMove(player) {
  for (const line of WIN_LINES) {
    const mine = line.filter(i=>board[i]===player);
    const free = line.filter(i=>board[i]===null);
    if (mine.length === 2 && free.length === 1) return free[0];
  }
  return -1;
}

function scorePlace(node, player) {
  let s = 0;
  for (const line of WIN_LINES) {
    if (!line.includes(node)) continue;
    s += line.filter(i=>board[i]===player).length + 1;
  }
  return s;
}

function aiPickMove() {
  const mine = board.map((v,i)=>v===2?i:-1).filter(i=>i!==-1);

  // Win immediately
  for (const from of mine) {
    for (const to of ADJACENCY[from]) {
      if (board[to]!==null) continue;
      board[to]=2; board[from]=null;
      const w = checkWin(2);
      board[from]=2; board[to]=null;
      if (w) return {from, to};
    }
  }

  // Block immediate loss
  const opp = board.map((v,i)=>v===1?i:-1).filter(i=>i!==-1);
  for (const from of opp) {
    for (const to of ADJACENCY[from]) {
      if (board[to]!==null) continue;
      board[to]=1; board[from]=null;
      const w = checkWin(1);
      board[from]=1; board[to]=null;
      if (w) {
        for (const myFrom of mine) {
          if (ADJACENCY[myFrom].includes(to)) return {from:myFrom, to};
        }
      }
    }
  }

  if (aiDifficulty === 'easy') {
    const moves = [];
    for (const from of mine)
      for (const to of ADJACENCY[from])
        if (board[to]===null) moves.push({from,to});
    return moves.length ? rand(moves) : null;
  }

  // Hard: detect and block forks, create own forks
  if (aiDifficulty === 'hard') {
    // Block opponent fork move
    const forkBlock = findMoveBlockFork(mine);
    if (forkBlock) return forkBlock;

    // Create our own fork
    const forkCreate = findMoveCreateFork(mine);
    if (forkCreate) return forkCreate;
  }

  // Medium & Hard: scored move
  const moves = [];
  for (const from of mine)
    for (const to of ADJACENCY[from])
      if (board[to]===null) moves.push({from, to, score: evalMove(from, to)});
  if (!moves.length) return null;
  moves.sort((a,b)=>b.score-a.score);
  return moves[0];
}

// Find a move that blocks the opponent from creating a fork next turn
function findMoveBlockFork(mine) {
  const opp = board.map((v,i)=>v===1?i:-1).filter(i=>i!==-1);
  // Check every opponent move ‚Äî if it creates 2+ threats, we must block that destination
  const forkSquares = new Set();
  for (const from of opp) {
    for (const to of ADJACENCY[from]) {
      if (board[to] !== null) continue;
      board[to]=1; board[from]=null;
      const threats = countMovingThreats(1);
      board[from]=1; board[to]=null;
      if (threats >= 2) forkSquares.add(to);
    }
  }
  if (forkSquares.size === 0) return null;
  // Try to move one of our pieces to a fork square to block it
  for (const target of forkSquares) {
    for (const from of mine) {
      if (ADJACENCY[from].includes(target) && board[target] === null) {
        return {from, to: target};
      }
    }
  }
  return null;
}

// Count winning threats for a player in the moving phase
function countMovingThreats(player) {
  let threats = 0;
  for (const line of WIN_LINES) {
    const mine = line.filter(i => board[i] === player).length;
    const free = line.filter(i => board[i] === null).length;
    if (mine === 2 && free === 1) threats++;
  }
  return threats;
}

// Find a move that creates 2+ threats for us (a fork)
function findMoveCreateFork(mine) {
  for (const from of mine) {
    for (const to of ADJACENCY[from]) {
      if (board[to] !== null) continue;
      board[to]=2; board[from]=null;
      const threats = countMovingThreats(2);
      board[from]=2; board[to]=null;
      if (threats >= 2) return {from, to};
    }
  }
  return null;
}

function evalMove(from, to) {
  board[to]=2; board[from]=null;
  let s = 0;
  for (const line of WIN_LINES) {
    const mine = line.filter(i=>board[i]===2).length;
    const free = line.filter(i=>board[i]===null).length;
    if (mine+free===3) s += mine*mine;
  }
  if (to===8) s+=3;
  board[from]=2; board[to]=null;
  return s;
}

// =============================================
// UI
// =============================================

function updateUI() {
  if (gameOver) return;
  const isAI = aiEnabled && currentPlayer === 2;
  const banner = document.getElementById('phaseBanner');
  banner.className = 'phase-banner ' + (currentPlayer === 1 ? 'player1-turn' : isAI ? 'ai-thinking-bg' : 'player2-turn');
  document.getElementById('turnName').textContent = playerNames[currentPlayer-1];

  if (phase === 'placing') {
    const rem = 3 - placedCount[currentPlayer-1];
    document.getElementById('phaseLabel').textContent = `Place a counter ‚Äî ${rem} left`;
    if (!isAI) setInstruction('Place your counter on any empty spot');
  } else {
    document.getElementById('phaseLabel').textContent = 'Move phase ‚Äî slide a counter';
    if (!isAI && !selectedNode) setInstruction('Select one of your counters to move');
  }
  updateDots();
}

function updateScoreBar() {
  const s = scores[currentMode];
  document.getElementById('gameScore1').textContent = s.p1;
  document.getElementById('gameScore2').textContent = s.p2;
  document.getElementById('gameScoreName1').textContent = playerNames[0];
  document.getElementById('gameScoreName2').textContent = playerNames[1];
  document.getElementById('labelP1').textContent = playerNames[0];
  document.getElementById('labelP2').textContent = playerNames[1];
}

function setInstruction(t) { document.getElementById('instructionText').textContent = t; }

function updateDots() {
  ['p1Dots','p2Dots'].forEach((id,i) => {
    const el = document.getElementById(id);
    el.innerHTML = '';
    for (let j=0;j<3;j++) {
      const d = document.createElement('div');
      d.className = 'counter-dot ' + (i===0?'p1':'p2');
      el.appendChild(d);
    }
  });
}

function renderBoard() {
  for (let i=0;i<9;i++) {
    const el = document.getElementById('node'+i);
    if (!el) continue;
    const sel = selectedNode===i;
    const valid = phase==='moving' && selectedNode!==null && board[i]===null && ADJACENCY[selectedNode].includes(i);

    if (board[i]===null) {
      if (valid) {
        el.style.fill='rgba(201,168,76,0.15)';
        el.style.stroke='#c9a84c';
        el.style.strokeWidth='2.5';
        el.style.strokeDasharray='4,3';
      } else {
        el.style.fill='#2a2a2a';
        el.style.stroke='#666';
        el.style.strokeWidth='1.5';
        el.style.strokeDasharray='';
      }
    } else if (board[i]===1) {
      el.style.fill='#c0392b';
      el.style.stroke=sel?'#c9a84c':'#e74c3c';
      el.style.strokeWidth=sel?'4':'2';
      el.style.strokeDasharray='';
    } else {
      el.style.fill='#f5f0e8';
      el.style.stroke=sel?'#c9a84c':'#c8bfa8';
      el.style.strokeWidth=sel?'4':'2';
      el.style.strokeDasharray='';
    }
  }
}

function toggleHTP() {
  document.getElementById('htpBody').classList.toggle('open');
  document.getElementById('htpArrow').classList.toggle('open');
}

// =============================================
// INIT
// =============================================

loadScores();
showHome();

document.getElementById('nameInput1').addEventListener('input', updateTallyDisplay);
document.getElementById('nameInput2').addEventListener('input', updateTallyDisplay);
</script>

<!-- end -->
</body>
</html>
